## `后端服务器组`指令

### upstream

**upstream指令**是设置 `后端服务器组` 的主要指令. 其他指令都在该指令中进行配置. **upstream指令** 
类似**http块**, **server块**等, 语法结构如下:

```
upstream NAME  {
    ...
}
```

其中 `NAME` 是 `后端服务器组` 的组名(类似server的server_name). 花括号中列出后端服务器组中包含的服务器. 
其中可以使用后面介绍的指令.

默认情况下, 某个服务器组接收到请求之后, 按照**轮询(RR)策略**顺序选择组内服务器处理请求. 如果一个服务器在
处理请求的过程中出现错误, 请求会被顺次交给组内的下一个服务器进行处理, 以此类推, 直到返回正常响应. 但如果组
内服务器都出错, 则返回最后一个服务器的处理结果.


### server

**server指令**用于设置组内的服务器. 语法结构如下:

```
server ADDRESS [PARAMETERS];
```

*ADDRESS*, 服务器的地址, 可以是包含端口号的IP地址(IP:Port), 域名 或者 以"unix:"为前缀用于进程间通信的
Unix Domain Socket.

*PARAMETERS*, 为当前服务器配置更多属性. 包括以下内容:

```
weight=N, 为组内服务器设置权重, 权重高的服务器优先用于处理请求. 此时组内服务器的选择策略是加权轮询策略. 组内
所有服务器的权重默认是1

max_fails=N, 设置一个请求失败的次数. 在一定时间范围内, 当对前服务器请求失败的次数超过该变量设置的值时, 认为
该服务器无效(down). 请求失败的各种情况与 proxy_next_upstream 指令的配置相配置. 默认设置为1. 如果设置为0,
则不使用上述的办法检查服务器是否有效.

注: HTTP 404 状态不认为是请求失败.

fail_timeout=time, 两个作用, 一是设置max_fails指令尝试请求某台组内服务器的时间, 即 max_fails 当中说的
"一定时间范围内". 二是检查服务器是否有效, 如果一台服务器被认为是无效(down)的, 该变量设置的时间为服务器无效的持
续时间. 在这个时间范围内不再检查该服务器的状态, 并一直认为它是无效(down)的. 默认设置是10s.

backup, 将某台组内服务器标记为备用服务器, 只有当正常的服务器处于无效(down)状态或者繁忙(busy)状态时, 该服务
器才被用来处理客户端的请求.

down, 将组内的某台服务器标记为永久的无效状态, 通常与ip_hash配合使用
```


### **ip_hash(策略)**

**ip_hash指令**用于实现会话保持功能, 将某个客户端的多次请求定向到组内同一台服务器上, 保证客户端与服务器之间建
立稳定的会话. 只有当该服务器处于无效(down)状态时, 客户端请求才会被下一个服务器接收和处理.

```
ip_hash;
```

注意:
首先, **ip_hash指令**不能与*server指令中的weight变量*一起使用. 其次, 由于ip_hash技术主要根据客户端IP地址
分配服务器, 因此在整个系统中, Nginx服务器应该是处于最前段的服务器, 这样才能获取到客户端的IP地址, 否则它得到的
IP地址将是位于它前面服务器地址, 从而产生问题.

案例:

```
http {
    upstream servers.mydomain.com {
        server 192.168.2.3:80; // 端口可改
        server 192.168.2.4:80; 
        ip_hash;
    }
    
    server { 
        listen 80; 
        server_name www.mydomain.com; 
        location / { 
            proxy_pass http://servers.mydomain.com; 
            proxy_set_header Host $host; 
            proxy_set_header X-Real-IP $remote_addr; 
        } 
    } 
}
```


### keepalive

**keepalive指令**用于控制网络连接保持功能. 通过该指令, 能够保持nginx服务器的工作进程为服务器组打开一部分
网络连接, 并且将数量控制在一定的范围之内.

```
keepalive CONNECTIONS;
```

其中, *CONNECTIONS*为服务器的每一个工作进程允许该服务器组保持的空闲网络连接数的上限值. 如果超过该值, 工作
进程将采用**最近最少使用**的策略关闭网络连接.


### **least_conn(策略)**

**least_conn指令**用于配置nginx服务器使用负载均衡策略为为网络连接分配服务器组内的服务器. 该指令在功能上实
现了**最少连接负载均衡算法**, 在选择组内的服务器时, 考虑各服务器权重的同时,每次选择的都是当前网络连接最少的那
台服务器, 如果这样的服务器有多台, 就采用加权轮询原则选择权重最大的服务器.

```
least_conn;
```
