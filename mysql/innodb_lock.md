# Innodb 锁

## 共享和独占锁定

InnoDB实现标准行级锁定, 其中有两种类型的锁, 即shared(S)锁和exclusive(X)锁.

- 一个共享(S)锁允许持有锁读取行的事务.

- 一个独占(X)锁允许持有锁, 更新或删除行的事务.

如果事务在行上T1持有共享(S)锁r, 那么来自某个不同事务的T2对锁定行的请求r将按如下方式处理:
  a) 由A请求T2用于S锁可以立即被授予. 其结果是, 无论是T1与T2持有S的锁r.
  b) 通过请求T2一个X锁不能立即授予.

如果一个事务T1持有一个exclusive(X)锁定行r, 那么不能立即授予来自某个不同事务T2的任何一个类型的锁的请求r. 相反,事务T2必
须等待事务T1才能释放行上的锁r.


## 意图锁定

InnoDB支持多个粒度锁定, 允许在整个表上共存行级锁和锁. 为了实现多个粒度级别的锁定, 使用额外类型的锁, 称为意向锁. 意向锁
是表级锁, 表示事务对于该表中的某一行稍后需要哪种类型的锁(共享或排他). InnoDB有两种类型的意图锁使用(假设事务T请求在表上
指定类型的锁t):

- 意图shared(IS): 事务T打算S在表中的单个行上设置锁t.
- 意向exclusive(IX): 事务T打算X在这些行上设置锁.

例如, SELECT ... LOCK IN SHARE MODE设置IS锁定, SELECT ... FOR UPDATE设置IX锁定.

意向锁定协议如下:
- 在一个事物可以获得一个表中一行的共享锁之前, 它必须首先获得这张表的IS锁或这张表的更强的锁.
- 在一个事务可以获得一个表中一行的排他锁之前, 它必须先获得这张表IX锁.

这些规则可以通过下面的锁类型兼容性矩阵方便地总结.

|  | X | IX | S | IS |
| --- | --- | --- | --- | --- |
| X | 冲突 | 冲突 | 冲突 | 冲突 |
| IX | 冲突 | 兼容 | 冲突 | 兼容 |
| S | 冲突 | 冲突 | 兼容 | 兼容 |
| IS | 冲突 | 兼容 | 兼容 | 兼容 |

如果请求的事务与现有的锁定兼容, 授予锁定, 但如果它与现有的锁定冲突, 则锁定将被拒绝, 事务一直等到冲突的现有锁被释放. 如果
锁定请求与现有的锁定发生冲突, 并且由于会导致死锁而无法被授予, 则会发生错误.
