# TCP/IP 卷一: 协议

## 数据链路层

- IEEE802.2/802.3 (RFC 1042) 和 以太网 (RFC 894)的封装格式

![image](/images/protocol_802.png)

- PPP

![image](/images/protocal_ppp.png)


## 网络层

- IP

![image](/images/protocol_ip.png)

第一个 32 bit是基本信息, 第二个 32 bit 是分片功能,

1) 版本: 4 bit, 当前是 IPv4, 即 0100

2) 首部长度: 4 bit, 头部占32bit的数字, 包括可选项. 取值范围是 5-15

3) 区分服务(DS, 6bit), 显示拥塞通知(ECN, 2bit): 8 bit

> 最开始, 这个字段定义为服务类型: 8 bit, 前3bit为优先权(已被忽略), 4-7bit分别代表延迟, 吞吐量, 可靠性和花费, 第8bit
暂时保留未使用. 例如 TELNET协议可能要求最小延迟, FTP协议可能要求最大吞吐量, SNMP(Simple Network Management Protocol)
协议可能要求最高可靠性, NNTP(Network News Transfer Protocol)协议可能要求最小花费.

4) 总长度: 16bit, 包括头部+数据的长度.

---

5) 标识字段: 16bit, 帮助标识IPv4主机发送的数据报. 为了避免将一个数据报分片和其他数据报分片混淆, 发送主机通常在每次发送
数据时都将一个内部计数器加1, 并将该计数器值复制到Ipv4标识字段.(对实现分片很重要)

6) 分段标志: 3 bit

7) 段偏移量: 13 bit

---

8) 生存周期: 8bit, 设置数据报可以经过路由器数量的上限.

9) 协议字段: 8bit, 表示数据报有效载荷部分的数据类型. 最常见的值为 17(UDP) 和 6(TCP)

10) 头部校验和: 16bit, 对头部每个16bit进行二进制反码求和.

---

11) 源IP: 32 bit

12) 目标IP: 32bit

## 传输层

- TCP

![image](/images/protocol_tcp.png)

1) 源端口: 16 bit

2) 目标端口: 16 bit

--- 

3) 序列号: 32 bit, 标识了TCP发送端到TCP接收端的数据流的一个字节, 该字节代表者包含该序列号的报文段数据中的第一个字节.

---

4) 确认号: 32 bit (ACK字段), 该确认号的发送方期待接收的下一个序列号, 即最后被成功接收的数据字节的序列号+1

--- 

5) 头部长度: 4bit, 以32bit为单位. 取值范围是 5-15

6) 保留位: 4 bit, 

7) 标志位: 8 bit, CWR(拥塞窗口减, 发送方降低它的发送速率), ECE(ECN回显, 发送方收到了一个更早的拥塞通告), URG(紧急,
紧急指针字段有效), ACK, PSH, RST, SYN, FIN.

8) 窗口大小: 16 bit

---

9) TCP 校验和: 16 bit, 校验TCP头部和数据.

10) 紧急指针: 16 bit, 只有在 URG 位字段被设置时才有效. 这个"指针"是一个必须要加到报文段的序列号字段上的正偏移, 以产生
紧急数据的最后一个字节的序列号.


- UDP

![image](/images/protocol_udp.png)

1) 源端口: 16 bit

2) 目标端口: 16 bit

--- 

3) 长度: 16 bit, UDP头部和UDP数据的总长度, 以字节为单位, 最小值是8

4) 校验和: 16 bit, UDP头部和UDP数据
